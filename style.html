<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="page-post">
  <header class="page-header">
    <a class="back-link" href="form.php">&larr; ä¸€è¦§ã«æˆ»ã‚‹</a>
    <h1 class="page-title">æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ </h1>
  </header>

  <main class="post-main">
    <div class="container">
      <form id="postForm" action="upload.php" method="post" enctype="multipart/form-data">
        <section class="title-section">
          <label for="title">ã‚¿ã‚¤ãƒˆãƒ«ï¼š</label>
          <input type="text" id="title" name="title" required>
        </section>

        <section class="pdf-section">
          <label for="pdf">PDFã‚’æ·»ä»˜ï¼š</label>
          <input type="file" id="pdf" name="pdf" accept="application/pdf" required>
        </section>

        <section class="audio-section">
          <h2>ğŸ¤ éŸ³å£°ã‚’å¹ãè¾¼ã‚€</h2>
          <div class="audio-controls">
            <button type="button" id="startBtn">éŒ²éŸ³é–‹å§‹</button>
            <button type="button" id="stopBtn" disabled>éŒ²éŸ³åœæ­¢</button>
          </div>
          <p class="recording-status" id="recordingStatus" role="status" aria-live="polite">éŒ²éŸ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦éŸ³å£°ã‚’å¹ãè¾¼ã‚“ã§ãã ã•ã„ã€‚</p>
          <audio id="audioPlayback" controls></audio>
          <input type="hidden" name="audioData" id="audioData">
        </section>

        <div class="submit-btn">
          <button type="submit">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    (function () {
      const form = document.getElementById('postForm');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const audioPlayback = document.getElementById('audioPlayback');
      const audioDataInput = document.getElementById('audioData');
      const statusElem = document.getElementById('recordingStatus');
      const submitBtn = form ? form.querySelector('button[type="submit"]') : null;

      let mediaRecorder = null;
      let activeStream = null;
      let audioChunks = [];
      let playbackUrl = null;

      const submitInitiallyDisabled = submitBtn ? submitBtn.disabled : false;
      let submitLocked = false;

      const toggleSubmitLock = (locked) => {
        if (!submitBtn || submitInitiallyDisabled) {
          submitLocked = false;
          return;
        }
        submitLocked = locked;
        submitBtn.disabled = locked;
      };

      const setStatus = (message, state = 'info') => {
        if (!statusElem) {
          return;
        }

        statusElem.textContent = message;
        statusElem.classList.remove('status-error', 'status-success');
        if (state === 'error') {
          statusElem.classList.add('status-error');
        } else if (state === 'success') {
          statusElem.classList.add('status-success');
        }
      };

      const releaseStream = () => {
        if (activeStream) {
          activeStream.getTracks().forEach((track) => track.stop());
          activeStream = null;
        }
      };

      const resetPlayback = () => {
        if (playbackUrl) {
          URL.revokeObjectURL(playbackUrl);
          playbackUrl = null;
        }
        audioPlayback.removeAttribute('src');
        audioPlayback.load();
      };

      const mediaRecordingSupported = typeof MediaRecorder !== 'undefined' &&
        navigator.mediaDevices &&
        typeof navigator.mediaDevices.getUserMedia === 'function';

      if (!mediaRecordingSupported) {
        startBtn.disabled = true;
        stopBtn.disabled = true;
        setStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŒ²éŸ³æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚åˆ¥é€”éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã”æº–å‚™ãã ã•ã„ã€‚', 'error');
        return;
      }

      const resolveRecorderOptions = () => {
        if (typeof MediaRecorder.isTypeSupported !== 'function') {
          return undefined;
        }

        const preferredTypes = [
          'audio/webm;codecs=opus',
          'audio/webm',
          'audio/ogg;codecs=opus',
          'audio/ogg',
          'audio/mp4',
        ];

        const mimeType = preferredTypes.find((type) => MediaRecorder.isTypeSupported(type));
        return mimeType ? { mimeType } : undefined;
      };

      startBtn.addEventListener('click', async () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          return;
        }

        try {
          activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        } catch (error) {
          setStatus(`ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ: ${error.message}`, 'error');
          return;
        }

        audioChunks = [];
        audioDataInput.value = '';
        resetPlayback();
        toggleSubmitLock(true);

        const recorderOptions = resolveRecorderOptions();

        try {
          mediaRecorder = recorderOptions ? new MediaRecorder(activeStream, recorderOptions) : new MediaRecorder(activeStream);
        } catch (error) {
          releaseStream();
          toggleSubmitLock(false);
          setStatus(`éŒ²éŸ³ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸ: ${error.message}`, 'error');
          return;
        }

        mediaRecorder.addEventListener('dataavailable', (event) => {
          if (event.data && event.data.size > 0) {
            audioChunks.push(event.data);
          }
        });

        mediaRecorder.addEventListener('error', (event) => {
          mediaRecorder = null;
          toggleSubmitLock(false);
          releaseStream();
          setStatus(`éŒ²éŸ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${event.error ? event.error.message : event.message || event.name}`, 'error');
          startBtn.disabled = false;
          stopBtn.disabled = true;
        });

        mediaRecorder.addEventListener('stop', () => {
          const recorder = mediaRecorder;
          mediaRecorder = null;
          const mimeType = (recorder && recorder.mimeType) || (recorderOptions && recorderOptions.mimeType) || 'audio/webm';
          releaseStream();
          stopBtn.disabled = true;
          startBtn.disabled = false;

          if (audioChunks.length === 0) {
            toggleSubmitLock(false);
            setStatus('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦éŒ²éŸ³ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
          }

          const blob = new Blob(audioChunks, { type: mimeType });
          playbackUrl = URL.createObjectURL(blob);
          audioPlayback.src = playbackUrl;
          audioPlayback.load();
          setStatus('éŒ²éŸ³ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å†ç”Ÿãƒœã‚¿ãƒ³ã§å†…å®¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚', 'success');

          const reader = new FileReader();
          reader.onloadend = () => {
            audioDataInput.value = reader.result;
            toggleSubmitLock(false);
          };
          reader.onerror = () => {
            audioDataInput.value = '';
            toggleSubmitLock(false);
            setStatus('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦éŒ²éŸ³ã—ã¦ãã ã•ã„ã€‚', 'error');
          };
          reader.readAsDataURL(blob);
        });

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        setStatus('éŒ²éŸ³ä¸­ã§ã™ã€‚åœæ­¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ä¿å­˜ã•ã‚Œã¾ã™ã€‚');
      });

      stopBtn.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
      });

      if (form) {
        form.addEventListener('submit', (event) => {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            event.preventDefault();
            setStatus('éŒ²éŸ³ã‚’åœæ­¢ã—ã¦ã‹ã‚‰æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
          }

          if (submitLocked) {
            event.preventDefault();
            setStatus('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™ã€‚å®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚');
          }
        });
      }
    })();
  </script>
</body>
</html>
