<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>お知らせを投稿</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="page-post">
  <header class="page-header">
    <a class="back-link" href="form.php">&larr; 一覧に戻る</a>
    <h1 class="page-title">投稿フォーム</h1>
  </header>

  <main class="post-main">
    <div class="container">
      <form id="postForm" action="upload.php" method="post" enctype="multipart/form-data">
        <section class="title-section">
          <label for="title">タイトル：</label>
          <input type="text" id="title" name="title" required>
        </section>

        <section class="pdf-section">
          <label for="pdf">PDFを添付：</label>
          <input type="file" id="pdf" name="pdf" accept="application/pdf" required>
        </section>

        <section class="audio-section">
          <h2>🎤 音声を吹き込む</h2>
          <div class="audio-controls">
            <button type="button" id="startBtn">録音開始</button>
            <button type="button" id="stopBtn" disabled>録音停止</button>
          </div>
          <p class="recording-status" id="recordingStatus" role="status" aria-live="polite">録音開始ボタンを押して音声を吹き込んでください。</p>
          <audio id="audioPlayback" controls></audio>
          <input type="hidden" name="audioData" id="audioData">
        </section>

        <div class="submit-btn">
          <button type="submit">投稿する</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    (function () {
      const form = document.getElementById('postForm');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const audioPlayback = document.getElementById('audioPlayback');
      const audioDataInput = document.getElementById('audioData');
      const statusElem = document.getElementById('recordingStatus');
      const submitBtn = form ? form.querySelector('button[type="submit"]') : null;

      let mediaRecorder = null;
      let activeStream = null;
      let audioChunks = [];
      let playbackUrl = null;

      const submitInitiallyDisabled = submitBtn ? submitBtn.disabled : false;
      let submitLocked = false;

      const toggleSubmitLock = (locked) => {
        if (!submitBtn || submitInitiallyDisabled) {
          submitLocked = false;
          return;
        }
        submitLocked = locked;
        submitBtn.disabled = locked;
      };

      const setStatus = (message, state = 'info') => {
        if (!statusElem) {
          return;
        }

        statusElem.textContent = message;
        statusElem.classList.remove('status-error', 'status-success');
        if (state === 'error') {
          statusElem.classList.add('status-error');
        } else if (state === 'success') {
          statusElem.classList.add('status-success');
        }
      };

      const releaseStream = () => {
        if (activeStream) {
          activeStream.getTracks().forEach((track) => track.stop());
          activeStream = null;
        }
      };

      const resetPlayback = () => {
        if (playbackUrl) {
          URL.revokeObjectURL(playbackUrl);
          playbackUrl = null;
        }
        audioPlayback.removeAttribute('src');
        audioPlayback.load();
      };

      const mediaRecordingSupported = typeof MediaRecorder !== 'undefined' &&
        navigator.mediaDevices &&
        typeof navigator.mediaDevices.getUserMedia === 'function';

      if (!mediaRecordingSupported) {
        startBtn.disabled = true;
        stopBtn.disabled = true;
        setStatus('このブラウザでは録音機能をご利用いただけません。別途音声ファイルをご準備ください。', 'error');
        return;
      }

      const resolveRecorderOptions = () => {
        if (typeof MediaRecorder.isTypeSupported !== 'function') {
          return undefined;
        }

        const preferredTypes = [
          'audio/webm;codecs=opus',
          'audio/webm',
          'audio/ogg;codecs=opus',
          'audio/ogg',
          'audio/mp4',
        ];

        const mimeType = preferredTypes.find((type) => MediaRecorder.isTypeSupported(type));
        return mimeType ? { mimeType } : undefined;
      };

      startBtn.addEventListener('click', async () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          return;
        }

        try {
          activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        } catch (error) {
          setStatus(`マイクにアクセスできませんでした: ${error.message}`, 'error');
          return;
        }

        audioChunks = [];
        audioDataInput.value = '';
        resetPlayback();
        toggleSubmitLock(true);

        const recorderOptions = resolveRecorderOptions();

        try {
          mediaRecorder = recorderOptions ? new MediaRecorder(activeStream, recorderOptions) : new MediaRecorder(activeStream);
        } catch (error) {
          releaseStream();
          toggleSubmitLock(false);
          setStatus(`録音を初期化できませんでした: ${error.message}`, 'error');
          return;
        }

        mediaRecorder.addEventListener('dataavailable', (event) => {
          if (event.data && event.data.size > 0) {
            audioChunks.push(event.data);
          }
        });

        mediaRecorder.addEventListener('error', (event) => {
          mediaRecorder = null;
          toggleSubmitLock(false);
          releaseStream();
          setStatus(`録音中にエラーが発生しました: ${event.error ? event.error.message : event.message || event.name}`, 'error');
          startBtn.disabled = false;
          stopBtn.disabled = true;
        });

        mediaRecorder.addEventListener('stop', () => {
          const recorder = mediaRecorder;
          mediaRecorder = null;
          const mimeType = (recorder && recorder.mimeType) || (recorderOptions && recorderOptions.mimeType) || 'audio/webm';
          releaseStream();
          stopBtn.disabled = true;
          startBtn.disabled = false;

          if (audioChunks.length === 0) {
            toggleSubmitLock(false);
            setStatus('音声データを取得できませんでした。もう一度録音してください。', 'error');
            return;
          }

          const blob = new Blob(audioChunks, { type: mimeType });
          playbackUrl = URL.createObjectURL(blob);
          audioPlayback.src = playbackUrl;
          audioPlayback.load();
          setStatus('録音が完了しました。再生ボタンで内容を確認できます。', 'success');

          const reader = new FileReader();
          reader.onloadend = () => {
            audioDataInput.value = reader.result;
            toggleSubmitLock(false);
          };
          reader.onerror = () => {
            audioDataInput.value = '';
            toggleSubmitLock(false);
            setStatus('音声データの変換に失敗しました。もう一度録音してください。', 'error');
          };
          reader.readAsDataURL(blob);
        });

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        setStatus('録音中です。停止ボタンを押すと保存されます。');
      });

      stopBtn.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
      });

      if (form) {
        form.addEventListener('submit', (event) => {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            event.preventDefault();
            setStatus('録音を停止してから投稿してください。', 'error');
            return;
          }

          if (submitLocked) {
            event.preventDefault();
            setStatus('音声データを処理しています。完了までお待ちください。');
          }
        });
      }
    })();
  </script>
</body>
</html>
